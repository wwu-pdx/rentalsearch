<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"> 
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <meta http-equiv="cache-control" content="no-cache" />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <title>Apartment-Housing Rental</title>
  </head>
<body >
<div>
<h1 style="text-align:center">Search for Apartments or Houses</h1>
</div>
<div>
  <form action="/" method = "post" id="form1">

    <div class="form-row">
      <div class="form-group col-md-3">
        <label for="zip">Zip</label>
        <input type="text" class="form-control zip" id="zip" placeholder="97201"  maxlength="5" name="zip"  required>
        <div class="text-error"></div>
      </div>
      <div class="form-group col-md-3">
        <label for="city">City</label>
        <input type="text" class="form-control city" id="city" placeholder="Portland" name="city"  required>
      </div>
      <div class="form-group col-md-3">
        <label for="state">State</label>
        <input type="text" class="form-control state" id="state" placeholder="OR"  name="state" maxlength="2" required>
      </div>
      <div class="form-group col-md-3">
        <label for="odby">Order by</label>
        <select  class="custom-select odby"  id="orderby"  name="odby">
          <option value="1" selected>Price asc</option>
          <option value="2">Price desc</option>
          <option value="3">Sqft asc</option>
          <option value="4">Sqft desc</option>
        </select>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group col-md-6">
        <label for="addr">Street Address</label>
        <input type="text" class="form-control addr" id="addr" placeholder="123 Main St"  name="addr">
        <small id="addrHelpBlock" class="form-text text-muted">
          Pass an optional address for looking up a specific property. The address should be formatted as street address; Will get ignored if radius is empty
        </small>
      </div>
      <div class="form-group col-md-2">
        <label for="radius">Radius</label>
        <input type="number" class="form-control radius" id="radius" min="10" max="200"  step= "10" name="radius">
        <small id="radiusHelpBlock" class="form-text text-muted">
          Filter listings within this specified number of kilometers. You must provide an address parameters when using a radius search; Will get ignored if address is empty
        </small>
      </div>
      <div class="form-group col-md-2">
        <label for="bed">Bedroom</label>
        <input type="number" class="form-control bed" id="bed" min="1" max="99" name="bed" >
        <small id="bedHelpBlock" class="form-text text-muted">
          Will get ignored if address or radius is empty
        </small>
      </div>
      <div class="form-group col-md-2">
        <label for="bath">Bathroom</label>
        <input type="number" class="form-control bath" id="bath" min="1" max="99" name="bath" >
        <small id="bathHelpBlock" class="form-text text-muted">
          Will get ignored if address or radius is empty
        </small>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group col-md-6">
        <button type="submit" class="btn btn-info">Search</button>
      </div>
      <div class="form-group col-md-6">
        <button type="reset" class="btn btn-secondary">Reset</button>
      </div>
    </div>
    
  </form>
  
</div>

<div class=container>

  <!--search result-->
  

    <!--result titile-->
    <div class="row">
      <h2>Search Results</h2>
    </div>

    <!--result list-->
   <ol>
      {% for d in data %}
      {% if d.status=='Active' %}      
        
          
            <div class="row">
              <li>          
              <label class="item"  for="geo{{loop.index}}">
                <b>{{d.propertyType}}: &nbsp; {{d.bathrooms}}baths &nbsp; {{d.bedrooms}}beds &nbsp; {{d.squareFootage}}sqft &nbsp; ${{d.price}} &nbsp; {{d.bedrooms}}beds &nbsp; {{d.daysOnMarket}}&nbsp; days on market </b>
                <small> (Address: {{d.rawAddress}})</small>
                <input class="check-item" type="checkbox" name="geodata" value="{{d.rawAddress}}" id = "geo{{loop.index}}">
              </label>
              </li>
             </div>
         
        
      {% endif %}
      {% endfor %}
    </ol>
  </div>


  <!--map-->
<div class=container>
  <div class="row">

    <!--map input-->
   
  
        <label for="addrm">Starting Address:
        <input type="text" class="addrm" id="addrm" placeholder="123 Main St"  name="addrm"> 
     
        <button type="submit" class="btn btn-primary btnm" id ="mapbtn">Add Start and Destinations</button>
 
  </div>

    <!--google map-->
    <div class="row">

      <div class="col" style="height:40vw" id ="map">
     
      </div>
  
      <div class="col" style="height:40vw;border:solid 1px black" id ="output">
       
      </div>
    </div>
    
    
  </div>





<script type="text/javascript">


//zipcode API
// get city and state by zip
	$(function() {
    // IMPORTANT: Fill in your client key
    
		var clientKey = "js-IZ0pt4DP5uk3xRvsCQfK6DLZHf6T4h96d531QBqHilLOO6Frgjk3kcS3BDLNaUxO";
		
		var cache = {};
		var container = $("#form1");
		var errorDiv = container.find("div.text-error");
		
		/** Handle successful response */
		function handleResp(data)
		{
			// Check for error
			if (data.error_msg)
				errorDiv.text(data.error_msg);
			else if ("city" in data)
			{
				// Set city and state
				container.find("input[name='city']").val(data.city);
				container.find("input[name='state']").val(data.state);
			}
		}
		
		// Set up event handlers
		container.find("input[name='zip']").on("keyup change", function() {
			// Get zip code
			var zip = $(this).val().substring(0, 5);
			if (zip.length == 5 && /^[0-9]+$/.test(zip))
			{
				// Clear error
				errorDiv.empty();
				
				// Check cache
				if (zip in cache)
				{
					handleResp(cache[zip]);
				}
				else
				{
					// Build url
					var url = "http://www.zipcodeapi.com/rest/"+clientKey+"/info.json/" + zip + "/radians";
					
					// Make AJAX request
					$.ajax({
						"url": url,
						"dataType": "json"
					}).done(function(data) {
						handleResp(data);
						
						// Store in cache
						cache[zip] = data;
					}).fail(function(data) {
						if (data.responseText && (json = $.parseJSON(data.responseText)))
						{
							// Store in cache
							cache[zip] = json;
							
							// Check for error
							if (json.error_msg)
								errorDiv.text(json.error_msg);
						}
						else
							errorDiv.text('Request failed.');
					});
				}
			}
		}).trigger("change");
  });
  

  let selectedlocations =[];
  let dests =[]
  let origins =[];
  
  var markersArray = [];
  var destinationIcon = 'https://chart.googleapis.com/chart?' +
            'chst=d_map_pin_letter&chld=D|FF0000|000000';
  var originIcon = 'https://chart.googleapis.com/chart?' +
            'chst=d_map_pin_letter&chld=O|FFFF00|000000';
  function initMap() {

    var bounds = new google.maps.LatLngBounds;

        var map = new google.maps.Map(document.getElementById('map'), {
          zoom: 8,
          center: {lat: 45.52345, lng: -122.67621}//
        });
      
       var geocoder = new google.maps.Geocoder();
       var service = new google.maps.DistanceMatrixService;

        document.getElementById('mapbtn').addEventListener('click', function() {
          if (prepareData()){
            //console.log(origins);
            console.log(dests);
            //console.log(selectedlocations);
            var adds= [document.getElementById('addrm').value.trim()];
            //geocodeAddress(geocoder, map, adds, 0);
            console.log(adds);
            disMaxtrix(service, geocoder, map, adds, dests, bounds, 1)
          }
          
        });
      }
    
      function prepareData(){
           selectedlocations =[];
           dests =[]
           origins =[];
          var valid = true;
          var checkedValue = document.querySelectorAll('.check-item:checked');
          //console.log(checkedValue)
        if (checkedValue.length >0 && checkedValue.length<9){
          for(var i=0; checkedValue[i]; ++i){
            var checkeddata = checkedValue[i].value;
            selectedlocations[i]= checkeddata
            //dests[i]={lat: checkeddata["latitude"], lng: checkeddata["longitude"]}
            dests[i]= checkeddata
            }
        }else{
            valid = false;

        }
          var start = document.getElementById('addrm');
          console.log(start.value)
          if(start == null){
            valid = false;
          }else{
            if(start.value.trim().length == 0 ){

              valid = false;
            }

          }

          return valid;
          
        }
      
      function deleteMarkers(markersArray) {
        for (var i = 0; i < markersArray.length; i++) {
          markersArray[i].setMap(null);
        }
        markersArray = [];
      }

      function disMaxtrix(service, geocoder, map,org, dests,  bounds,mode){

        service.getDistanceMatrix({
          origins: org,
          destinations: dests,
          travelMode: 'DRIVING',
          unitSystem: google.maps.UnitSystem.METRIC,
          avoidHighways: false,
          avoidTolls: false
        }, function(response, status) {
          if (status !== 'OK') {
            alert('Error was: ' + status);
          } else {
            var originList = response.originAddresses;
            var destinationList = response.destinationAddresses;
            var outputDiv = document.getElementById('output');
            outputDiv.innerHTML = '';
            deleteMarkers(markersArray);

            var showGeocodedAddressOnMap = function(asDestination) {
              var icon = asDestination ? destinationIcon : originIcon;
              return function(results, status) {
                if (status === 'OK') {
                  map.fitBounds(bounds.extend(results[0].geometry.location));
                  markersArray.push(new google.maps.Marker({
                    map: map,
                    position: results[0].geometry.location,
                    icon: icon
                  }));
                } else {
                  alert('Geocode was not successful due to: ' + status);
                }
              };
            };

            for (var i = 0; i < originList.length; i++) {
              var results = response.rows[i].elements;
              geocoder.geocode({'address': originList[i]},
                  showGeocodedAddressOnMap(false));
              for (var j = 0; j < results.length; j++) {
                geocoder.geocode({'address': destinationList[j]},
                    showGeocodedAddressOnMap(true));
                outputDiv.innerHTML += originList[i] + ' to ' + destinationList[j] +
                    ': ' + results[j].distance.text + ' in ' +
                    results[j].duration.text + '<br>';
              }
            }
          }
        });




      }

      

     function geocodeAddress(geocoder, resultsMap, adds, mode) {
        
        //var adds=["1100 Lloyd Center, Portland, OR 97232", "9700 SW Washington Square Rd, Tigard, OR 97223"]
       
        for (i = 0; i < adds.length; i++) {
        geocoder.geocode({'address': adds[i]}, function(results, status) {
          if (status === 'OK') {
            resultsMap.setCenter(results[0].geometry.location);
            console.log(results[0])
            var marker = new google.maps.Marker({
              map: resultsMap,
              position: results[0].geometry.location
            });
           //float window to show first return address from google map
           var infowindow = new google.maps.InfoWindow;
           infowindow.setContent(results[0].formatted_address);
           if (mode=0){
            origins[0] = results[0].formatted_address;
           }
           
           marker.addListener('click', function() {
            infowindow.open(map, marker);
           });
          } else {
            alert('Geocode was not successful for the following reason: ' + status);
          }
        });
      }






   }


</script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAnqtGnBhp7dsOKviCTt4Z5Gku0QtZgTis&callback=initMap"></script>



</body>

